<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Gerador de Procuração</title>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

  <!-- Render e PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --a4-w: 794px;
      --a4-h: 1123px;
      --brand: #0b57d0;
      --bg: #f5f5f5;
      --card: #fff;
      --text: #222;
      --muted:#666;
      --signature-offset: 96px;
    }
    html, body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family: Arial, Helvetica, sans-serif; }

    .upload-container{
      max-width: 760px; margin: 28px auto; background:var(--card);
      padding: 24px 28px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    h2{ margin:0 0 6px; text-align:center; }
    .instructions{ text-align:center; color:var(--muted); margin-bottom:16px; }

    .drop-area{
      display:flex; align-items:center; justify-content:center; text-align:center;
      padding:48px 20px; border:2px dashed #cfcfcf; border-radius:10px; background:#fafafa;
      color:#666; cursor:pointer; transition:.2s; user-select:none; -webkit-user-select:none;
    }
    .drop-area.dragover{ border-color: var(--brand); background:#f0f6ff; }
    .drop-area input[type=file]{ display:none; }

    .button-row{ margin-top:14px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    button{
      padding:10px 18px; border:0; border-radius:8px; cursor:pointer; font-weight:600;
      background:var(--brand); color:#fff; transition:.2s;
    }
    button.secondary{ background:#6c757d; }
    button:disabled{ background:#c9c9c9; cursor:not-allowed; }
    button:hover:not(:disabled){ filter: brightness(.92); }

    .preview-section{
      max-width: 1000px; margin: 16px auto 28px; background: var(--card);
      padding: 16px 18px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.06);
      display:none;
    }
    .preview-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .preview-title{ font-weight:700; }
    .preview-wrap{
      display:flex; align-items:center; justify-content:center;
      background:#111; padding:14px; border-radius:10px;
    }
    .preview-viewport{ transform-origin: top left; }
    .preview-page{
      width: var(--a4-w);
      height: var(--a4-h);
      background:#fff;
      color:#000;
      padding: 40px 48px;
      line-height: 1.4;
      font-size: 12pt;
      box-sizing: border-box;
      overflow: hidden;
      transform-origin: top left;
    }
    .title{ text-align:center; font-weight:bold; font-size:18pt; }
    .justify{ text-align:justify; }
    .center{ text-align:center; }

    .signature{ margin-top: var(--signature-offset); }
    .signature .line{ text-align:center; margin:24px 0 6px; }
    .signature .note{ text-align:center; font-weight:bold; }

    .offscreen{
      position: fixed; left: -10000px; top: -10000px;
      width: var(--a4-w); height: var(--a4-h);
      opacity: .01; pointer-events: none; overflow: hidden;
      background:#fff;
    }

    *{ page-break-before:auto; page-break-after:auto; page-break-inside:avoid; }
  </style>
</head>
<body>
  <div class="upload-container">
    <h2>Gerador de Procuração de Repasse</h2>
    <p class="instructions">Arraste e solte o <b>PDF</b> do contrato abaixo ou clique para selecionar. A pré-visualização aparece logo abaixo e o PDF é gerado em <b>uma única página</b>.</p>

    <label class="drop-area" id="dropArea">
      Arraste e solte o arquivo PDF aqui ou clique para selecionar
      <input type="file" id="fileInput" accept="application/pdf" hidden />
    </label>

    <div class="button-row">
      <button id="generateBtn" disabled>Gerar PDF</button>
      <button id="clearBtn" class="secondary" disabled>Limpar</button>
    </div>
  </div>

  <!-- Pré-visualização -->
  <section class="preview-section" id="previewSection">
    <div class="preview-header">
      <div class="preview-title">Pré-visualização (fiel ao PDF)</div>
    </div>
    <div class="preview-wrap">
      <div class="preview-viewport" id="previewViewport">
        <div class="preview-page" id="previewPage">
          <div class="title">PROCURAÇÃO</div>
          <br /><br />
          <p id="p_para1" class="justify"></p>
          <br />
          <p id="p_para2" class="justify"></p>
          <br />
          <p id="p_vehicleInfo"></p>
          <br />
          <p id="p_cityDate" class="center"></p>
          <div class="signature">
            <p class="line">______________________________________________</p>
            <p class="note">(Assinatura reconhecida por autenticidade)</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Host offscreen para render do PDF -->
  <div class="offscreen" id="printHost">
    <div class="preview-page" id="printPage">
      <div class="title">PROCURAÇÃO</div>
      <br /><br />
      <p id="pp_para1" class="justify"></p>
      <br />
      <p id="pp_para2" class="justify"></p>
      <br />
      <p id="pp_vehicleInfo"></p>
      <br />
      <p id="pp_cityDate" class="center"></p>
      <div class="signature">
        <p class="line">______________________________________________</p>
        <p class="note">(Assinatura reconhecida por autenticidade)</p>
      </div>
    </div>
  </div>

  <script>
    const A4_W = 794;
    const A4_H = 1123;

    const els = {
      dropArea: document.getElementById('dropArea'),
      fileInput: document.getElementById('fileInput'),
      generateBtn: document.getElementById('generateBtn'),
      clearBtn: document.getElementById('clearBtn'),
      previewSection: document.getElementById('previewSection'),
      previewViewport: document.getElementById('previewViewport'),
      previewPage: document.getElementById('previewPage'),
      printPage: document.getElementById('printPage'),
      p_para1: document.getElementById('p_para1'),
      p_para2: document.getElementById('p_para2'),
      p_vehicleInfo: document.getElementById('p_vehicleInfo'),
      p_cityDate: document.getElementById('p_cityDate'),
      pp_para1: document.getElementById('pp_para1'),
      pp_para2: document.getElementById('pp_para2'),
      pp_vehicleInfo: document.getElementById('pp_vehicleInfo'),
      pp_cityDate: document.getElementById('pp_cityDate'),
    };

    let currentData = null;
    let pdfFilename = 'procuracao.pdf';

    // ===== Helpers =====
    const onlyDigits = (s) => (s || '').replace(/\D+/g, '');
    const isCPF = (s) => onlyDigits(s).length === 11;
    const isCNPJ = (s) => onlyDigits(s).length === 14;

    const isDocLabel  = (l) => /(C\.?P\.?F\.?|CPF|CNPJ|R\.?G\.?|RG|I\.?E\.?|IE)\s*:/i.test(l);
    const isPhoneLine = (l) => /\b(Fone|Fones|Telefone|Tel\.?|Comercial|Residencial|Celular)\b/i.test(l);
    const isStopLabel = (l) => /\b(Bairro|CEP|Cidade|Estado)\s*:/i.test(l) || isPhoneLine(l) || isDocLabel(l);

    const looksLikeStreet = (l) => {
      if (!l) return false;
      const hasStreetWord = /(RUA|R\.|R\s|AVENIDA|AV\.?|ALAMEDA|AL\.|TRAVESSA|TRAV\.|RODOVIA|ROD\.|ESTRADA|ESTR\.|PRAÇA|PRACA|CONDOM[IÍ]NIO|COND\.|LOTEAMENTO|LOT\.)/i.test(l);
      const hasNumber    = /(^|,|\s)\d{1,5}(\s|$|,)/.test(l) || /\bN[º°o]?\b/i.test(l);
      return hasStreetWord || (/[A-ZÁ-Ú]{3,}/i.test(l) && hasNumber);
    };

    function cleanAddress(s){
      if (!s) return '';
      s = s.replace(/(?:C\.?P\.?F\.?|CPF|CNPJ|R\.?G\.?|RG|I\.?E\.?|IE)\s*:\s*[\w\.\-\/]+/gi, '');
      s = s.split(/,(?=\s*(Bairro|CEP|Cidade|Estado)\s*:)/i)[0];
      s = s.split(/\b(Bairro|CEP|Cidade|Estado)\s*:/i)[0];
      return s.replace(/\s{2,}/g,' ').replace(/^[,\.;\-\s]+|[,\.;\-\s]+$/g,'').trim();
    }

    /* ===== ENDEREÇO PRIORITÁRIO: entre CPF/CNPJ e “Bairro:” ===== */
    function extractAddressBetweenDocAndBairro(fullText){
      const docRegex = /(CNPJ|CPF|C\.?P\.?F\.?)\s*:\s*([0-9.\-\/]{11,18})/i;
      const docMatch = fullText.match(docRegex);
      if (!docMatch) return '';

      const start = docMatch.index + docMatch[0].length;
      const after = fullText.slice(start);

      const endIdx = after.search(/Bairro\s*:/i);
      let segment = endIdx >= 0 ? after.slice(0, endIdx) : after;

      segment = segment.replace(/\s+/g,' ').trim();
      const cutAt = segment.search(/\b(CEP|Cidade|Estado|Fones?|Telefone|Tel\.?|E-?mail|Email|E-Mail|Cliente|Cadastro)\b/i);
      if (cutAt >= 0) segment = segment.slice(0, cutAt).trim();

      const addr = cleanAddress(segment);
      if (!addr) return '';
      if (looksLikeStreet(addr) || /\d{1,5}/.test(addr)) return addr;
      return addr;
    }

    /* ===== FALLBACK: endereço após Doc usando “R ” ===== */
    function extractAddressAfterDocR(fullText){
      const lines = fullText.split(/\n+/).map(l => l.trim()).filter(Boolean);
      const docR = /(CPF|C\.?P\.?F\.?|CNPJ)\s*:\s*[\d\.\-\/]{11,18}.*?\bR\.?\s+([^\n]+)/i;

      for (let i = 0; i < lines.length; i++) {
        const l = lines[i];
        const m = l.match(docR);
        if (m) {
          let addr = cleanAddress(m[2] || '');
          if (i + 1 < lines.length && !isStopLabel(lines[i+1])) {
            const n1 = cleanAddress(lines[i+1]);
            if (n1 && (/,\s*\d+/.test(n1) || looksLikeStreet(n1))) {
              addr = (addr + ' ' + n1).trim();
            }
          }
          if (looksLikeStreet(addr) || /\d{1,5}/.test(addr)) return addr;
        }
      }
      const g = fullText.replace(/\n+/g,' ').match(docR);
      if (g) {
        let addr = cleanAddress(g[2] || '');
        if (looksLikeStreet(addr) || /\d{1,5}/.test(addr)) return addr;
      }
      return '';
    }

    /* ===== CIDADE/UF com “ESPAÇO SIGNIFICATIVO” (colunas) ===== */
    function extractCityStateFromBairroBlock(fullText){
      const rawLines = fullText.replace(/\t/g, '    ').split(/\n+/);
      for (let i = 0; i < rawLines.length; i++){
        const line = rawLines[i].trim();
        if (!/Bairro\s*:/i.test(line)) continue;

        const afterLabel = line.replace(/.*Bairro\s*:\s*/i, '');
        const chunks = line.split(/\s{3,}/).map(s => s.trim()).filter(Boolean);

        let bairro = afterLabel.split(/\s{3,}/)[0].trim();

        let city = '', state = '';
        for (const ch of chunks){
          const m = ch.match(/([A-ZÀ-Ú][A-ZÀ-Ú\s]+?)\s*-\s*[A-Za-zÀ-ú\s]+?\s*-\s*([A-Z]{2})\b/i);
          if (m){
            city  = m[1].replace(/\s{2,}/g,' ').trim();
            state = (m[2] || '').trim();
            break;
          }
        }

        if (!city && i+1 < rawLines.length){
          for (let k = 1; k <= 2 && i+k < rawLines.length; k++){
            const nxt = rawLines[i+k].trim();
            const mm  = nxt.match(/([A-ZÀ-Ú][A-ZÀ-Ú\s]+?)\s*-\s*[A-Za-zÀ-ú\s]+?\s*-\s*([A-Z]{2})\b/i);
            if (mm){
              city  = mm[1].replace(/\s{2,}/g,' ').trim();
              state = (mm[2] || '').trim();
              break;
            }
          }
        }

        bairro = bairro.replace(/\s*-\s*[A-Za-zÀ-ú\s]+?\s*-\s*[A-Z]{2}\s*$/,'').trim();

        if (bairro || (city && state)){
          return { bairro, city, state };
        }
      }
      return null;
    }

    // Fallback global: "Cidade - Estado extenso - UF"
    function extractCityUfGlobal(text){
      const m = text.match(/([A-ZÀ-Ú][A-ZÀ-Ú\s]+?)\s*-\s*[A-Za-zÀ-ú\s]+?\s*-\s*([A-Z]{2})/i);
      if (m) return { city: m[1].trim().replace(/\s+/g,' '), state: m[2].trim() };
      return { city:'', state:'' };
    }

    function cleanBairroAgainstCity(bairro, city){
      if (!bairro) return '';
      let b = bairro.replace(/\s*-\s*[A-Za-zÀ-ú\s]+?\s*-\s*[A-Z]{2}\s*$/,'');
      if (city){
        const eq = new RegExp('^\\s*' + city.replace(/\s+/g,'\\s+') + '\\s*$', 'i');
        if (eq.test(b)) b = '';
        const tail = new RegExp('\\s+' + city.replace(/\s+/g,'\\s+') + '\\s*$', 'i');
        b = b.replace(tail,'');
      }
      return b.replace(/\s{2,}/g,' ').trim();
    }

    /* ===== CORREÇÃO AQUI: manter o nome COMPLETO da cidade ===== */
    function refineCity(rawCity, bairro){
      if (!rawCity) return '';
      let c = rawCity.replace(/\s{2,}/g,' ').trim();

      // Se vier “Bairro + Cidade” colados, remove o bairro do início
      if (bairro){
        const bx = bairro.replace(/\s+/g,'\\s+');
        const rx = new RegExp('^' + bx + '[,\\s\\-]+', 'i');
        c = c.replace(rx, '').trim();
      }

      // Limpa bordas/hífens residuais
      c = c.replace(/^\s*[-,]+\s*/,'').replace(/\s*[-,]+\s*$/,'').trim();

      // >>> Não cortar mais para “últimas 2–3 palavras”! <<<
      return c;
    }

    function extractNameFallback(text){
      const m = text.match(/(?:^|\n)([^,\n]{3,}?),\s*(?:CPF\/CNPJ|CPF|CNPJ)\s*:/i);
      if (m) {
        let nm = (m[1] || '').trim();
        if (!/PROCURA[ÇC]ÃO|CONTRATO|CLIENTE\s*:|ENDEREÇO\s*:|RAZ[ÃA]O/i.test(nm)) {
          return nm.replace(/\s{2,}/g,' ');
        }
      }
      return '';
    }

    // ====== Extração principal ======
    function extractFields(text) {
      const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);

      let name='', address='', bairro='', cep='', city='', state='', cnpj='',
          model='', plate='', ano='', chassis='', renavam='', color='';

      // DOC
      const findLabeledCNPJ = () => {
        for (const l of lines) {
          if (isPhoneLine(l)) continue;
          const m = l.match(/CNPJ\s*:?\s*([\d\.\-\/]{14,18})/i);
          if (m && isCNPJ(m[1])) return m[1];
        }
        return null;
      };
      const findLabeledCPF = () => {
        for (const l of lines) {
          if (isPhoneLine(l)) continue;
          const m = l.match(/(?:C\.?P\.?F\.?|CPF)\s*:?\s*([\d\.\-]{11,14})/i);
          if (m && isCPF(m[1])) return m[1];
        }
        return null;
      };
      const findMixedDoc = () => {
        for (const l of lines) {
          if (isPhoneLine(l)) continue;
          const m = l.match(/CPF\/CNPJ\s*:\s*([^\n,]+)/i);
          if (m) {
            const d = onlyDigits(m[1]);
            if (d.length === 14 || d.length === 11) return m[1];
          }
        }
        return null;
      };
      const findLooseCNPJ = () => {
        const reFmt = /\b\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}\b/;
        const re14d = /(?:\D|^)(\d{2}\D?\d{3}\D?\d{3}\D?\d{4}\D?\d{2})(?:\D|$)/;
        for (const l of lines) {
          if (isPhoneLine(l)) continue;
          const m1 = l.match(reFmt);
          if (m1) return m1[0];
          const m2 = l.match(re14d);
          if (m2 && isCNPJ(m2[1])) return m2[1];
        }
        return null;
      };

      let doc = findLabeledCNPJ() || findLabeledCPF() || findMixedDoc() || findLooseCNPJ();
      if (doc) {
        const d = onlyDigits(doc);
        if (d.length === 14 || d.length === 11) cnpj = doc;
      }

      // NOME
      const nameMatch = text.match(/Cliente\s*:\s*([^\n,]+)/i);
      if (nameMatch) {
        let nm = nameMatch[1];
        nm = nm.split(/CPF|C\.?P\.?F|CNPJ|Cadastro/i)[0];
        name = nm.trim();
      }
      if (!name) name = extractNameFallback(text);

      // ENDEREÇO — PRIORITÁRIO
      address = extractAddressBetweenDocAndBairro(text) || extractAddressAfterDocR(text);

      // BAIRRO / CIDADE / UF — coluna com espaço significativo
      const bx = extractCityStateFromBairroBlock(text);
      if (bx){
        bairro = bx.bairro;
        city   = bx.city;
        state  = bx.state;
      } else {
        const bairroLbl = text.match(/Bairro\s*:\s*([^\n,]+)/i);
        if (bairroLbl) bairro = (bairroLbl[1] || '').trim();
        const loc = extractCityUfGlobal(text);
        city = loc.city; state = loc.state;
        if (!city) { const cityLbl = text.match(/Cidade\s*:\s*([^\n,]+)/i); if (cityLbl) city = (cityLbl[1] || '').trim(); }
        if (!state){ const ufLbl   = text.match(/Estado\s*:\s*([A-Z]{2})/i); if (ufLbl)   state = (ufLbl[1] || '').trim(); }
      }

      // Limpezas cruzadas
      if (city)   city   = refineCity(city, bairro);
      if (bairro) bairro = cleanBairroAgainstCity(bairro, city);

      // CEP
      const cepMatchGlobal = [...text.matchAll(/CEP\s*:\s*([\d\-\.]+)/gi)];
      if (cepMatchGlobal.length) cep = (cepMatchGlobal[cepMatchGlobal.length - 1][1] || '').replace(/\D/g,'').padStart(8,'0');

      // VEÍCULO
      const modelMatch = text.match(/Ve[ií]culo\s*:\s*([^\n]+?)(?=\s+Placa|\s+Chassi|\n)/i);
      if (modelMatch) model = modelMatch[1].trim();

      let plateCandidate = '';
      const placaIndex = text.search(/Placa/i);
      if (placaIndex >= 0) {
        const start = Math.max(0, placaIndex - 30);
        const before = text.substring(start, placaIndex);
        const beforeMatch = before.match(/([A-Z]{3}[A-Z0-9\-]{4,5})\s*$/i);
        if (beforeMatch) {
          let raw = beforeMatch[1].replace(/\s+/g,'').toUpperCase();
          if (/^[A-Z]{3}[0-9]{4}$/.test(raw)) plateCandidate = raw.slice(0,3)+'-'+raw.slice(3);
          else if (/^[A-Z]{3}[0-9][A-Z][0-9]{2}$/.test(raw)) plateCandidate = raw;
          else plateCandidate = raw;
        }
        if (!plateCandidate) {
          const after = text.substring(placaIndex);
          const afterMatch = after.match(/Placa\s*:\s*([A-Z0-9\-]{3,8})/i);
          if (afterMatch) {
            let raw = afterMatch[1].trim().replace(/\s+/g,'').toUpperCase();
            if (/^[A-Z]{3}[0-9]{4}$/.test(raw)) plateCandidate = raw.slice(0,3)+'-'+raw.slice(3);
            else if (/^[A-Z]{3}[0-9][A-Z][0-9]{2}$/.test(raw)) plateCandidate = raw;
            else plateCandidate = raw;
          }
        }
      }
      if (!plateCandidate) {
        const list = text.match(/([A-Z]{3}\-?[0-9][A-Z][0-9]{2})/gi);
        if (list && list.length) {
          let raw = list[0].replace(/\s|-/g,'').toUpperCase();
          if (/^[A-Z]{3}[0-9]{4}$/.test(raw)) plate = raw.slice(0,3)+'-'+raw.slice(3);
          else if (/^[A-Z]{3}[0-9][A-Z][0-9]{2}$/.test(raw)) plate = raw;
          else plate = raw;
        }
      }
      if (!plate && plateCandidate) plate = plateCandidate;

      let anoMatch = text.match(/Ano\s*\/\s*Modelo[^0-9]*([0-9]{2}\/[0-9]{2}|[0-9]{4}\/[0-9]{4})/i);
      if (!anoMatch) {
        const genericYear = text.match(/\b([1-2][0-9]\/[1-2][0-9])\b/);
        if (genericYear) anoMatch = [null, genericYear[1]];
      }
      if (anoMatch) {
        let val = anoMatch[1];
        if (/^[0-9]{2}\/[0-9]{2}$/.test(val)) { const p = val.split('/'); ano = '20'+p[0]+'/20'+p[1]; }
        else ano = val;
      }

      const chassiMatch = text.match(/Chassi\s*:?\s*([A-Za-z0-9]+)/i);
      if (chassiMatch) chassis = chassiMatch[1];

      const renMatch = text.match(/Renavam\s*:?\s*(\d+)/i);
      if (renMatch) renavam = renMatch[1];

      const colorMatch = text.match(/Cor\s*:\s*([^/\n]+)/i);
      if (colorMatch) color = colorMatch[1].split('/')[0].trim();

      return { name, cnpj, address, bairro, cep, city, state, model, plate, ano, chassis, renavam, color };
    }

    // ====== Preenche nós ======
    function fillPreview(data){
      els.p_para1.innerHTML =
        `Por este instrumento particular de procuração, <b>${data.name || ''}</b>, CPF/CNPJ: <b>${data.cnpj || ''}</b>, ` +
        `ENDEREÇO: <b>${data.address || ''}</b>, BAIRRO: <b>${data.bairro || ''}</b>, CEP: <b>${data.cep || ''}</b>, ` +
        `CIDADE: <b>${data.city || ''}</b>, ESTADO: <b>${data.state || ''}</b>.`;

      els.p_para2.innerHTML =
        'Dados pelos quais responsabilizo-me civil e criminalmente, nomeio e constituo meu bastante procurador: ' +
        'RAMIRO ILHA, portador do CPF: 375.722.450-72 e RG: 9021949971, domiciliado na Rua Dr. Voltaire Pires, Nº 430, ' +
        'na cidade de Porto Alegre/RS, para os fins específicos de assinar a GRT, Guia de Responsabilidade Técnica, e também o ' +
        '"DE ACORDO" na compra do veículo descrito abaixo:';

      els.p_vehicleInfo.innerHTML =
        `MODELO DO VEÍCULO: <b>${data.model || ''}</b><br>` +
        `PLACA: <b>${data.plate || ''}</b><br>` +
        `ANO/MODELO: <b>${data.ano || ''}</b><br>` +
        `CHASSI: <b>${data.chassis || ''}</b><br>` +
        `RENAVAM: <b>${data.renavam || ''}</b><br>` +
        `COR: <b>${data.color || ''}</b>`;

      els.p_cityDate.innerText =
        'CIDADE: ________________, ESTADO: ___, ____ de _______________ de ____.';
    }

    function fillPrint(data){
      els.pp_para1.innerHTML =
        `Por este instrumento particular de procuração, <b>${data.name || ''}</b>, CPF/CNPJ: <b>${data.cnpj || ''}</b>, ` +
        `ENDEREÇO: <b>${data.address || ''}</b>, BAIRRO: <b>${data.bairro || ''}</b>, CEP: <b>${data.cep || ''}</b>, ` +
        `CIDADE: <b>${data.city || ''}</b>, ESTADO: <b>${data.state || ''}</b>.`;

      els.pp_para2.innerHTML =
        'Dados pelos quais responsabilizo-me civil e criminalmente, nomeio e constituo meu bastante procurador: ' +
        'RAMIRO ILHA, portador do CPF: 375.722.450-72 e RG: 9021949971, domiciliado na Rua Dr. Voltaire Pires, Nº 430, ' +
        'na cidade de Porto Alegre/RS, para os fins específicos de assinar a GRT, Guia de Responsabilidade Técnica, e também o ' +
        '"DE ACORDO" na compra do veículo descrito abaixo:';

      els.pp_vehicleInfo.innerHTML =
        `MODELO DO VEÍCULO: <b>${data.model || ''}</b><br>` +
        `PLACA: <b>${data.plate || ''}</b><br>` +
        `ANO/MODELO: <b>${data.ano || ''}</b><br>` +
        `CHASSI: <b>${data.chassis || ''}</b><br>` +
        `RENAVAM: <b>${data.renavam || ''}</b><br>` +
        `COR: <b>${data.color || ''}</b>`;

      els.pp_cityDate.innerText =
        'CIDADE: ________________, ESTADO: ___, ____ de _______________ de ____.';
    }

    // ====== Layout/Export ======
    function autoscaleToA4(node){
      node.style.transform = 'scale(1)';
      const contentH = node.scrollHeight;
      if (contentH <= A4_H) return 1;
      const scale = A4_H / contentH;
      node.style.transformOrigin = 'top left';
      node.style.transform = `scale(${scale})`;
      return scale;
    }

    function fitPreviewViewport(){
      const vp = els.previewViewport;
      const availableW = vp.parentElement.clientWidth - 10;
      const scale = Math.min(availableW / A4_W, 1);
      vp.style.transform = `scale(${scale})`;
      vp.style.width = (A4_W * scale) + 'px';
      vp.style.height = (A4_H * scale) + 'px';
    }

    async function generatePDF(){
      if (!currentData) return;

      fillPrint(currentData);
      autoscaleToA4(els.printPage);

      const canvas = await html2canvas(els.printPage, {
        scale: 2,
        backgroundColor: '#FFFFFF',
        useCORS: true,
        logging: false
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'px', format:[A4_W, A4_H], orientation:'portrait' });
      pdf.addImage(imgData, 'JPEG', 0, 0, A4_W, A4_H);
      pdf.save(pdfFilename);
    }

    async function extractAllPagesText(pdf) {
      const pages = [];
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const text = content.items.map(i => i.str).join('\n');
        pages.push(text);
      }
      return pages.join('\n');
    }

    function handlePDFFile(file){
      if (!file || file.type !== 'application/pdf') return;
      const reader = new FileReader();
      reader.onload = async function(){
        const typedarray = new Uint8Array(this.result);
        const doc = await pdfjsLib.getDocument(typedarray).promise;

        const fullText = await extractAllPagesText(doc);

        currentData = extractFields(fullText);

        const sanitizedPlate = currentData.plate ? currentData.plate.replace(/[^A-Za-z0-9]/g,'') : 'PLACADESCONHECIDA';
        const sanitizedName  = currentData.name ? currentData.name.replace(/\s+/g,'_') : 'CLIENTE';
        pdfFilename = `PROCURACAO_${sanitizedPlate}_${sanitizedName}.pdf`;

        fillPreview(currentData);
        fillPrint(currentData);

        autoscaleToA4(els.previewPage);
        autoscaleToA4(els.printPage);

        els.previewSection.style.display = 'block';
        fitPreviewViewport();

        els.generateBtn.disabled = false;
        els.clearBtn.disabled = false;
      };
      reader.readAsArrayBuffer(file);
    }

    // Eventos
    const da = document.getElementById('dropArea');
    const fi = document.getElementById('fileInput');
    fi.addEventListener('change', (e)=>{ const f = e.target.files[0]; handlePDFFile(f); });
    da.addEventListener('dragover', (e)=>{ e.preventDefault(); da.classList.add('dragover'); });
    da.addEventListener('dragleave', ()=> da.classList.remove('dragover'));
    da.addEventListener('drop', (e)=>{
      e.preventDefault(); da.classList.remove('dragover');
      const f = e.dataTransfer.files[0]; handlePDFFile(f);
    });

    els.generateBtn.addEventListener('click', generatePDF);
    els.clearBtn.addEventListener('click', ()=>{
      fi.value = '';
      els.generateBtn.disabled = true;
      els.clearBtn.disabled = true;
      els.previewSection.style.display = 'none';
      currentData = null;
      pdfFilename = 'procuracao.pdf';
      els.p_para1.innerHTML = els.p_para2.innerHTML = els.p_vehicleInfo.innerHTML = '';
      els.p_cityDate.innerHTML = '';
      els.pp_para1.innerHTML = els.pp_para2.innerHTML = els.pp_vehicleInfo.innerHTML = '';
      els.pp_cityDate.innerHTML = '';
    });

    window.addEventListener('resize', ()=> {
      if (els.previewSection.style.display === 'block') fitPreviewViewport();
    });
  </script>
</body>
</html>
