<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Gerador de Procuração</title>

  <!-- Leitura do PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

  <!-- Render e PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --a4-w: 794px;    /* 210mm @ ~96dpi */
      --a4-h: 1123px;   /* 297mm @ ~96dpi */
      --brand: #0b57d0;
      --bg: #f5f5f5;
      --card: #fff;
      --text: #222;
      --muted:#666;
      --signature-offset: 96px; /* mantém a assinatura mais para baixo */
    }
    html, body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family: Arial, Helvetica, sans-serif; }

    .upload-container{
      max-width: 760px; margin: 28px auto; background:var(--card);
      padding: 24px 28px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.08);
    }
    h2{ margin:0 0 6px; text-align:center; }
    .instructions{ text-align:center; color:var(--muted); margin-bottom:16px; }

    .drop-area{
      display:flex; align-items:center; justify-content:center; text-align:center;
      padding:48px 20px; border:2px dashed #cfcfcf; border-radius:10px; background:#fafafa;
      color:#666; cursor:pointer; transition:.2s; user-select:none; -webkit-user-select:none;
    }
    .drop-area.dragover{ border-color: var(--brand); background:#f0f6ff; }
    .drop-area input[type=file]{ display:none; }

    .button-row{ margin-top:14px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    button{
      padding:10px 18px; border:0; border-radius:8px; cursor:pointer; font-weight:600;
      background:var(--brand); color:#fff; transition:.2s;
    }
    button.secondary{ background:#6c757d; }
    button:disabled{ background:#c9c9c9; cursor:not-allowed; }
    button:hover:not(:disabled){ filter: brightness(.92); }

    /* ===== Pré-visualização inline ===== */
    .preview-section{
      max-width: 1000px; margin: 16px auto 28px; background: var(--card);
      padding: 16px 18px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.06);
      display:none;
    }
    .preview-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .preview-title{ font-weight:700; }
    .preview-wrap{
      display:flex; align-items:center; justify-content:center;
      background:#111; padding:14px; border-radius:10px;
    }
    .preview-viewport{ transform-origin: top left; }
    .preview-page{
      width: var(--a4-w);
      height: var(--a4-h);
      background:#fff;
      color:#000;
      padding: 40px 48px;
      line-height: 1.4;
      font-size: 12pt;
      box-sizing: border-box;
      overflow: hidden;
      transform-origin: top left;
    }
    .title{ text-align:center; font-weight:bold; font-size:18pt; }
    .justify{ text-align:justify; }
    .center{ text-align:center; }

    /* Assinatura */
    .signature{ margin-top: var(--signature-offset); }
    .signature .line{ text-align:center; margin:24px 0 6px; }
    .signature .note{ text-align:center; font-weight:bold; }

    /* Espaço extra antes de “CIDADE/ESTADO” (mantido) */
    #p_cityDate, #pp_cityDate { margin-top: 2em; }

    /* Host offscreen (render para html2canvas) */
    .offscreen{
      position: fixed; left: -10000px; top: -10000px;
      width: var(--a4-w); height: var(--a4-h);
      opacity: .01; pointer-events: none; overflow: hidden;
      background:#fff;
    }

    *{ page-break-before:auto; page-break-after:auto; page-break-inside:avoid; }
  </style>
</head>
<body>
  <div class="upload-container">
    <h2>Gerador de Procuração de Repasse</h2>
    <p class="instructions">Arraste e solte o <b>PDF</b> do contrato abaixo ou clique para selecionar. A pré-visualização aparece logo abaixo e o PDF é gerado em <b>uma única página</b>.</p>

    <label class="drop-area" id="dropArea">
      Arraste e solte o arquivo PDF aqui ou clique para selecionar
      <input type="file" id="fileInput" accept="application/pdf" hidden />
    </label>

    <div class="button-row">
      <button id="generateBtn" disabled>Gerar PDF</button>
      <button id="clearBtn" class="secondary" disabled>Limpar</button>
    </div>
  </div>

  <!-- Pré-visualização inline -->
  <section class="preview-section" id="previewSection">
    <div class="preview-header">
      <div class="preview-title">Pré-visualização (fiel ao PDF)</div>
    </div>
    <div class="preview-wrap">
      <div class="preview-viewport" id="previewViewport">
        <div class="preview-page" id="previewPage">
          <div class="title">PROCURAÇÃO</div>
          <br /><br />
          <p id="p_para1" class="justify"></p>
          <br />
          <p id="p_para2" class="justify"></p>
          <br />
          <p id="p_vehicleInfo"></p>
          <br />
          <p id="p_cityDate" class="center"></p>
          <div class="signature">
            <p class="line">______________________________________________</p>
            <p class="note">(Assinatura reconhecida por autenticidade)</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Host offscreen para render do PDF -->
  <div class="offscreen" id="printHost">
    <div class="preview-page" id="printPage">
      <div class="title">PROCURAÇÃO</div>
      <br /><br />
      <p id="pp_para1" class="justify"></p>
      <br />
      <p id="pp_para2" class="justify"></p>
      <br />
      <p id="pp_vehicleInfo"></p>
      <br />
      <p id="pp_cityDate" class="center"></p>
      <div class="signature">
        <p class="line">______________________________________________</p>
        <p class="note">(Assinatura reconhecida por autenticidade)</p>
      </div>
    </div>
  </div>

  <script>
    const A4_W = 794;
    const A4_H = 1123;

    const els = {
      dropArea: document.getElementById('dropArea'),
      fileInput: document.getElementById('fileInput'),
      generateBtn: document.getElementById('generateBtn'),
      clearBtn: document.getElementById('clearBtn'),
      previewSection: document.getElementById('previewSection'),
      previewViewport: document.getElementById('previewViewport'),
      previewPage: document.getElementById('previewPage'),
      printPage: document.getElementById('printPage'),
      // campos da prévia
      p_para1: document.getElementById('p_para1'),
      p_para2: document.getElementById('p_para2'),
      p_vehicleInfo: document.getElementById('p_vehicleInfo'),
      p_cityDate: document.getElementById('p_cityDate'),
      // campos do print
      pp_para1: document.getElementById('pp_para1'),
      pp_para2: document.getElementById('pp_para2'),
      pp_vehicleInfo: document.getElementById('pp_vehicleInfo'),
      pp_cityDate: document.getElementById('pp_cityDate'),
    };

    let currentData = null;
    let pdfFilename = 'procuracao.pdf';

    // ===== Helpers =====
    const onlyDigits = (s) => (s || '').replace(/\D+/g, '');
    const isCPF = (s) => onlyDigits(s).length === 11;
    const isCNPJ = (s) => onlyDigits(s).length === 14;

    const isDocLabel = (l) => /(C\.?P\.?F\.?|CPF|CNPJ|R\.?G\.?|RG|I\.?E\.?|IE)\s*:/i.test(l);
    const isPhoneLine = (l) => /\b(Fone|Fones|Telefone|Tel\.?)\b/i.test(l);
    const isStopLabel = (l) => /\b(Bairro|CEP|Cidade|Estado)\s*:/i.test(l) || isPhoneLine(l) || isDocLabel(l);

    // Heurística de logradouro (mais tolerante para PF)
    const looksLikeStreet = (l) => {
      if (!l) return false;
      const hasStreetWord = /(RUA|R\.|AVENIDA|AV\.?|ALAMEDA|AL\.|TRAVESSA|TRAV\.|RODOVIA|ROD\.|ESTRADA|ESTR\.|PRAÇA|PRACA|CONDOMÍNIO|COND\.|LOTEAMENTO|LOT\.)/i.test(l);
      const hasNumber = /(^|,|\s)\d{1,5}(\s|$|,)/.test(l) || /\bN[º°o]?\b/i.test(l);
      // aceita também padrões "RUA XXX, 123 AP 301" etc.
      return hasStreetWord || (/[A-ZÁ-Ú]{3,}/i.test(l) && hasNumber);
    };

    // Limpa caudas e remove trechos de documentos dentro da linha
    function cleanAddress(s){
      if (!s) return '';
      s = s.replace(/(?:C\.?P\.?F\.?|CPF|CNPJ|R\.?G\.?|RG|I\.?E\.?|IE)\s*:\s*[\w\.\-\/]+/gi, ''); // remove C.P.F.: xxx etc
      s = s.split(/,(?=\s*(Bairro|CEP|Cidade|Estado)\s*:)/i)[0];
      s = s.split(/\b(Bairro|CEP|Cidade|Estado)\s*:/i)[0];
      return s.replace(/\s{2,}/g,' ').replace(/^[,\.;\-\s]+|[,\.;\-\s]+$/g,'').trim();
    }

    // Coleta 1–2 linhas de endereço a partir de um índice
    function collectAddressFrom(lines, startIdx){
      let out = cleanAddress(lines[startIdx]);
      let used = 1;

      // Se a primeira linha for muito curta (ex.: só o nome da via), tenta anexar a próxima
      for (let k = 1; k <= 2 && startIdx + k < lines.length; k++){
        const nxt = lines[startIdx + k];
        if (!nxt || isStopLabel(nxt)) break;
        const cleaned = cleanAddress(nxt);
        if (!cleaned) continue;
        // concatena se ainda parecer parte do logradouro (número/complemento)
        if (looksLikeStreet(cleaned) || /,\s*\d+|APT|AP\.?|BL\.?|QD\.?|LT\.?/i.test(cleaned)) {
          out = (out ? (out + ' ' + cleaned) : cleaned).trim();
          used++;
        } else {
          break;
        }
      }
      return out.trim();
    }

    // ====== Extração de dados do PDF ======
    function extractFields(text) {
      const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);

      let name='', address='', bairro='', cep='', city='', state='', cnpj='',
          model='', plate='', ano='', chassis='', renavam='', color='';

      // --------- CPF/CNPJ (mantido com validação de tamanho e evitando telefone) ---------
      // CNPJ rotulado > CPF rotulado > "CPF/CNPJ:" > CNPJ solto
      const findLabeledCNPJ = () => {
        for (const l of lines) {
          if (isPhoneLine(l)) continue;
          const m = l.match(/CNPJ\s*:?\s*([\d\.\-\/]{14,18})/i);
          if (m && isCNPJ(m[1])) return m[1];
        }
        return null;
      };
      const findLabeledCPF = () => {
        for (const l of lines) {
          if (isPhoneLine(l)) continue;
          const m = l.match(/(?:C\.?P\.?F\.?|CPF)\s*:?\s*([\d\.\-]{11,14})/i);
          if (m && isCPF(m[1])) return m[1];
        }
        return null;
      };
      const findMixedDoc = () => {
        for (const l of lines) {
          if (isPhoneLine(l)) continue;
          const m = l.match(/CPF\/CNPJ\s*:\s*([^\n,]+)/i);
          if (m) {
            const d = onlyDigits(m[1]);
            if (d.length === 14 || d.length === 11) return m[1];
          }
        }
        return null;
      };
      const findLooseCNPJ = () => {
        const reFmt = /\b\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}\b/;
        const re14d = /(?:\D|^)(\d{2}\D?\d{3}\D?\d{3}\D?\d{4}\D?\d{2})(?:\D|$)/;
        for (const l of lines) {
          if (isPhoneLine(l)) continue;
          const m1 = l.match(reFmt);
          if (m1) return m1[0];
          const m2 = l.match(re14d);
          if (m2 && isCNPJ(m2[1])) return m2[1];
        }
        return null;
      };

      let doc = findLabeledCNPJ() || findLabeledCPF() || findMixedDoc() || findLooseCNPJ();
      if (doc) {
        const d = onlyDigits(doc);
        if (d.length === 14 || d.length === 11) cnpj = doc;
      }

      // --------- Nome ---------
      const nameMatch = text.match(/Cliente\s*:\s*([^\n,]+)/i);
      if (nameMatch) {
        let nm = nameMatch[1];
        nm = nm.split(/CPF|C\.?P\.?F|CNPJ|Cadastro/i)[0];
        name = nm.trim();
      }

      // --------- ENDEREÇO (CPF e CNPJ) — reforçado p/ CPF ---------
      // 1) Tenta rótulo "Endereço:"
      const enderecoLabelIdx = lines.findIndex(l => /Endere[cç]o\s*:/i.test(l));
      if (enderecoLabelIdx !== -1) {
        // pega da própria linha do rótulo…
        let candidate = cleanAddress(lines[enderecoLabelIdx].replace(/^.*Endere[cç]o\s*:\s*/i, ''));
        // …se vazio/curto, tenta coletar nas 2 próximas linhas (ignorando rótulos/telefone)
        if (!candidate || candidate.length < 6) {
          for (let k = 1; k <= 2 && enderecoLabelIdx + k < lines.length; k++) {
            const nxt = lines[enderecoLabelIdx + k];
            if (!nxt || isStopLabel(nxt)) break;
            const cleaned = cleanAddress(nxt);
            if (cleaned && (looksLikeStreet(cleaned) || candidate === '')) {
              candidate = candidate ? (candidate + ' ' + cleaned) : cleaned;
            }
          }
        }
        address = (candidate || '').trim();
      }

      // 2) Se ainda não achou, após "Cliente:" procurar primeira linha que pareça logradouro,
      //    pulando linhas de CPF/CNPJ/RG/Telefone; depois concatenar 1 próxima se fizer sentido.
      if (!address) {
        const clientIdx = lines.findIndex(l => /Cliente\s*:/i.test(l));
        if (clientIdx !== -1) {
          for (let j = clientIdx + 1; j < Math.min(clientIdx + 12, lines.length); j++) {
            const l = lines[j];
            if (!l) continue;
            if (isStopLabel(l)) {
              // se a linha é só rótulo (ex.: "C.P.F.: ..."), pula e continua procurando logradouro
              continue;
            }
            const cleaned = cleanAddress(l);
            if (looksLikeStreet(cleaned)) {
              address = collectAddressFrom(lines.map(cleanAddress), j);
              break;
            }
          }
        }
      }

      // 3) Fallback final: se ainda vazio e havia linha com CPF que também tinha logradouro após vírgula/hífen
      if (!address) {
        const cpfLineIdx = lines.findIndex(l => /(?:C\.?P\.?F\.?|CPF)\s*:/i.test(l));
        if (cpfLineIdx !== -1) {
          let tail = lines[cpfLineIdx].replace(/.*?(?:C\.?P\.?F\.?|CPF)\s*:\s*[\d\.\-]{11,14}\s*[,;\-–—]?\s*/i, '');
          tail = cleanAddress(tail);
          if (looksLikeStreet(tail)) {
            address = tail;
            // tenta anexar próxima linha se parecer complemento
            if (cpfLineIdx + 1 < lines.length && !isStopLabel(lines[cpfLineIdx + 1])) {
              const nextClean = cleanAddress(lines[cpfLineIdx + 1]);
              if (nextClean && (looksLikeStreet(nextClean) || /,\s*\d+|APT|AP\.?|BL\.?|QD\.?|LT\.?/i.test(nextClean))) {
                address = (address + ' ' + nextClean).trim();
              }
            }
          }
        }
      }

      // --------- Bairro / CEP ---------
      const bairroMatchGlobal = [...text.matchAll(/Bairro\s*:\s*([^\n,]+)/gi)];
      if (bairroMatchGlobal.length) bairro = bairroMatchGlobal[bairroMatchGlobal.length - 1][1].trim();

      const cepMatchGlobal = [...text.matchAll(/CEP\s*:\s*([\d\-\.]+)/gi)];
      if (cepMatchGlobal.length) cep = cepMatchGlobal[cepMatchGlobal.length - 1][1];

      // --------- Cidade / UF ---------
      if (!city || !state) {
        let sub = text;
        const clientPos = text.toLowerCase().indexOf('cliente');
        if (clientPos !== -1) sub = text.substring(clientPos);
        const m = sub.match(/([^\-\n]+)\s*-\s*[^\-\n]+\s*-\s*([A-Z]{2})/i);
        if (m) { city = m[1].trim(); state = m[2].trim(); }
      }

      // --------- Veículo (mantido) ---------
      const modelMatch = text.match(/Ve[ií]culo\s*:\s*([^\n]+?)(?=\s+Placa|\s+Chassi|\n)/i);
      if (modelMatch) model = modelMatch[1].trim();

      let plateCandidate = '';
      const placaIndex = text.search(/Placa/i);
      if (placaIndex >= 0) {
        const start = Math.max(0, placaIndex - 30);
        const before = text.substring(start, placaIndex);
        const beforeMatch = before.match(/([A-Z]{3}[A-Z0-9\-]{4,5})\s*$/i);
        if (beforeMatch) {
          let raw = beforeMatch[1].replace(/\s+/g,'').toUpperCase();
          if (/^[A-Z]{3}[0-9]{4}$/.test(raw)) plateCandidate = raw.slice(0,3)+'-'+raw.slice(3);
          else if (/^[A-Z]{3}[0-9][A-Z][0-9]{2}$/.test(raw)) plateCandidate = raw;
          else plateCandidate = raw;
        }
        if (!plateCandidate) {
          const after = text.substring(placaIndex);
          const afterMatch = after.match(/Placa\s*:\s*([A-Z0-9\-]{3,8})/i);
          if (afterMatch) {
            let raw = afterMatch[1].trim().replace(/\s+/g,'').toUpperCase();
            if (/^[A-Z]{3}[0-9]{4}$/.test(raw)) plateCandidate = raw.slice(0,3)+'-'+raw.slice(3);
            else if (/^[A-Z]{3}[0-9][A-Z][0-9]{2}$/.test(raw)) plateCandidate = raw;
            else plateCandidate = raw;
          }
        }
      }
      if (!plateCandidate) {
        const platePatternGlobal = /([A-Z]{3}\-?[0-9][A-Z][0-9]{2})/gi;
        const list = text.match(platePatternGlobal);
        if (list && list.length) {
          let raw = list[0].replace(/\s|-/g,'').toUpperCase();
          if (/^[A-Z]{3}[0-9]{4}$/.test(raw)) plate = raw.slice(0,3)+'-'+raw.slice(3);
          else if (/^[A-Z]{3}[0-9][A-Z][0-9]{2}$/.test(raw)) plate = raw;
          else plate = raw;
        }
      }
      if (!plate && plateCandidate) plate = plateCandidate;

      let anoMatch = text.match(/Ano\s*\/\s*Modelo[^0-9]*([0-9]{2}\/[0-9]{2}|[0-9]{4}\/[0-9]{4})/i);
      if (!anoMatch) {
        const genericYear = text.match(/\b([1-2][0-9]\/[1-2][0-9])\b/);
        if (genericYear) anoMatch = [null, genericYear[1]];
      }
      if (anoMatch) {
        let val = anoMatch[1];
        if (/^[0-9]{2}\/[0-9]{2}$/.test(val)) { const p = val.split('/'); ano = '20'+p[0]+'/20'+p[1]; }
        else ano = val;
      }

      const chassiMatch = text.match(/Chassi\s*:?\s*([A-Za-z0-9]+)/i);
      if (chassiMatch) chassis = chassiMatch[1];

      const renMatch = text.match(/Renavam\s*:?\s*(\d+)/i);
      if (renMatch) renavam = renMatch[1];

      const colorMatch = text.match(/Cor\s*:\s*([^/\n]+)/i);
      if (colorMatch) color = colorMatch[1].split('/')[0].trim();

      return { name, cnpj, address, bairro, cep, city, state, model, plate, ano, chassis, renavam, color };
    }

    // ====== Preenche nós (prévia e impressão) ======
    function fillPreview(data){
      els.p_para1.innerHTML =
        `Por este instrumento particular de procuração, <b>${data.name || ''}</b>, CPF/CNPJ: <b>${data.cnpj || ''}</b>, ` +
        `ENDEREÇO: <b>${data.address || ''}</b>, BAIRRO: <b>${data.bairro || ''}</b>, CEP: <b>${data.cep || ''}</b>, ` +
        `CIDADE: <b>${data.city || ''}</b>, ESTADO: <b>${data.state || ''}</b>.`;

      els.p_para2.innerHTML =
        'Dados pelos quais responsabilizo-me civil e criminalmente, nomeio e constituo meu bastante procurador: ' +
        'RAMIRO ILHA, portador do CPF: 375.722.450-72 e RG: 9021949971, domiciliado na Rua Dr. Voltaire Pires, Nº 430, ' +
        'na cidade de Porto Alegre/RS, para os fins específicos de assinar a GRT, Guia de Responsabilidade Técnica, e também o ' +
        '"DE ACORDO" na compra do veículo descrito abaixo:';

      els.p_vehicleInfo.innerHTML =
        `MODELO DO VEÍCULO: <b>${data.model || ''}</b><br>` +
        `PLACA: <b>${data.plate || ''}</b><br>` +
        `ANO/MODELO: <b>${data.ano || ''}</b><br>` +
        `CHASSI: <b>${data.chassis || ''}</b><br>` +
        `RENAVAM: <b>${data.renavam || ''}</b><br>` +
        `COR: <b>${data.color || ''}</b>`;

      els.p_cityDate.innerText =
        'CIDADE: ________________, ESTADO: ___, ____ de _______________ de ____.';
    }

    function fillPrint(data){
      els.pp_para1.innerHTML =
        `Por este instrumento particular de procuração, <b>${data.name || ''}</b>, CPF/CNPJ: <b>${data.cnpj || ''}</b>, ` +
        `ENDEREÇO: <b>${data.address || ''}</b>, BAIRRO: <b>${data.bairro || ''}</b>, CEP: <b>${data.cep || ''}</b>, ` +
        `CIDADE: <b>${data.city || ''}</b>, ESTADO: <b>${data.state || ''}</b>.`;

      els.pp_para2.innerHTML =
        'Dados pelos quais responsabilizo-me civil e criminalmente, nomeio e constituo meu bastante procurador: ' +
        'RAMIRO ILHA, portador do CPF: 375.722.450-72 e RG: 9021949971, domiciliado na Rua Dr. Voltaire Pires, Nº 430, ' +
        'na cidade de Porto Alegre/RS, para os fins específicos de assinar a GRT, Guia de Responsabilidade Técnica, e também o ' +
        '"DE ACORDO" na compra do veículo descrito abaixo:';

      els.pp_vehicleInfo.innerHTML =
        `MODELO DO VEÍCULO: <b>${data.model || ''}</b><br>` +
        `PLACA: <b>${data.plate || ''}</b><br>` +
        `ANO/MODELO: <b>${data.ano || ''}</b><br>` +
        `CHASSI: <b>${data.chassis || ''}</b><br>` +
        `RENAVAM: <b>${data.renavam || ''}</b><br>` +
        `COR: <b>${data.color || ''}</b>`;

      els.pp_cityDate.innerText =
        'CIDADE: ________________, ESTADO: ___, ____ de _______________ de ____.';
    }

    // ====== Autoscale p/ A4 ======
    function autoscaleToA4(node){
      node.style.transform = 'scale(1)';
      const contentH = node.scrollHeight;
      if (contentH <= A4_H) return 1;
      const scale = A4_H / contentH;
      node.style.transformOrigin = 'top left';
      node.style.transform = `scale(${scale})`;
      return scale;
    }

    function fitPreviewViewport(){
      const vp = els.previewViewport;
      const availableW = vp.parentElement.clientWidth - 10;
      const scale = Math.min(availableW / A4_W, 1);
      vp.style.transform = `scale(${scale})`;
      vp.style.width = (A4_W * scale) + 'px';
      vp.style.height = (A4_H * scale) + 'px';
    }

    // ====== PDF (1ª página, sem páginas extras) ======
    async function generatePDF(){
      if (!currentData) return;

      fillPrint(currentData);
      autoscaleToA4(els.printPage);

      const canvas = await html2canvas(els.printPage, {
        scale: 2,
        backgroundColor: '#FFFFFF',
        useCORS: true,
        logging: false
      });

      const imgData = canvas.toDataURL('image/jpeg', 0.95);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'px', format:[A4_W, A4_H], orientation:'portrait' });
      pdf.addImage(imgData, 'JPEG', 0, 0, A4_W, A4_H);
      pdf.save(pdfFilename);
    }

    // ====== Leitura do contrato ======
    function handlePDFFile(file){
      if (!file || file.type !== 'application/pdf') return;
      const reader = new FileReader();
      reader.onload = function(){
        const typedarray = new Uint8Array(this.result);
        pdfjsLib.getDocument(typedarray).promise.then(function(pdf){
          pdf.getPage(1).then(function(page){
            page.getTextContent().then(function(content){
              const text = content.items.map(i => i.str).join('\n');
              currentData = extractFields(text);

              const sanitizedPlate = currentData.plate ? currentData.plate.replace(/[^A-Za-z0-9]/g,'') : 'PLACADESCONHECIDA';
              const sanitizedName  = currentData.name ? currentData.name.replace(/\s+/g,'_') : 'CLIENTE';
              pdfFilename = `PROCURACAO_${sanitizedPlate}_${sanitizedName}.pdf`;

              fillPreview(currentData);
              fillPrint(currentData);

              autoscaleToA4(els.previewPage);
              autoscaleToA4(els.printPage);

              els.previewSection.style.display = 'block';
              fitPreviewViewport();

              els.generateBtn.disabled = false;
              els.clearBtn.disabled = false;
            });
          });
        });
      };
      reader.readAsArrayBuffer(file);
    }

    // ====== Eventos ======
    const da = document.getElementById('dropArea');
    const fi = document.getElementById('fileInput');
    fi.addEventListener('change', (e)=>{ const f = e.target.files[0]; handlePDFFile(f); });
    da.addEventListener('dragover', (e)=>{ e.preventDefault(); da.classList.add('dragover'); });
    da.addEventListener('dragleave', ()=> da.classList.remove('dragover'));
    da.addEventListener('drop', (e)=>{
      e.preventDefault(); da.classList.remove('dragover');
      const f = e.dataTransfer.files[0]; handlePDFFile(f);
    });

    els.generateBtn.addEventListener('click', generatePDF);
    els.clearBtn.addEventListener('click', ()=>{
      fi.value = '';
      els.generateBtn.disabled = true;
      els.clearBtn.disabled = true;
      els.previewSection.style.display = 'none';
      currentData = null;
      pdfFilename = 'procuracao.pdf';
      els.p_para1.innerHTML = els.p_para2.innerHTML = els.p_vehicleInfo.innerHTML = '';
      els.p_cityDate.innerHTML = '';
      els.pp_para1.innerHTML = els.pp_para2.innerHTML = els.pp_vehicleInfo.innerHTML = '';
      els.pp_cityDate.innerHTML = '';
    });

    window.addEventListener('resize', ()=> {
      if (els.previewSection.style.display === 'block') fitPreviewViewport();
    });
  </script>
</body>
</html>
